---
name: Deploy Terraform
on:
    workflow_dispatch:
    push:
        paths-ignore:
            - '**md'
    pull_request:
        branches:
            - main
        paths-ignore:
            - '**md'

env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    AWS_DEFAULT_REGION: eu-west-1
    AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    S3_BUCKET_NAME: simple-test-versioned-bucket
    ECR_REPO_NAME: db_data_import
    CI_VERSION: snapshot.${{github.sha}}

jobs:
    pre-commit:
        name: Run pre-commit
        runs-on: ubuntu-latest
        if: ${{ github.actor != 'dependabot[bot]' }}
        steps:
            - name: Checkout Repo
              uses: actions/checkout@v3
            - uses: actions/setup-python@v4
              with:
                  python-version: '3.10'
            - name: Install Poetry
              uses: snok/install-poetry@v1
              with:
                  virtualenvs-create: true
                  virtualenvs-in-project: true
                  installer-parallel: true
            - name: Load cached venv
              id: cached-dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      .venv
                      ~/.cache/pre-commit
                  key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}pre-commit|${{ env.PY }}|${{
                      hashFiles('.pre-commit-config.yaml') }}
            - name: Install dependencies
              if: steps.cached-dependencies.outputs.cache-hit != 'true'
              run: poetry install --no-interaction --no-root
            - name: Install pre-commit hooks
              if: steps.cached-dependencies.outputs.cache-hit != 'true'
              run: |
                  source .venv/bin/activate
                  pre-commit install-hooks
            - name: Run pre-commit
              run: |
                  SKIP=terraform_tflint pre-commit run --all-files

    tf_fmt_lint:
        name: Format and Lint Terraform
        runs-on: ubuntu-latest
        needs: [pre-commit]
        if: ${{ github.actor != 'dependabot[bot]' }}
        steps:
            - name: Checkout Repo
              uses: actions/checkout@v3

            - name: Set Cache Plugin Dir
              uses: actions/cache@v3
              with:
                  path: ~/.tflint.d/plugins
                  key: tflint-${{ hashFiles('.tflint.hcl') }}

            - name: Terraform Setup
              uses: hashicorp/setup-terraform@v2

            - name: Format Terraform Files
              id: fmt
              run: terraform fmt -recursive
              continue-on-error: true

            - name: Run TFlint in Docker Container
              run: |
                  docker run --rm -v $(pwd)/terraform/src:/data -t ghcr.io/terraform-linters/tflint

    terraform_apply:
        name: Run Terraform Apply
        runs-on: ubuntu-latest
        needs: [tf_fmt_lint]
        if: ${{ github.actor != 'dependabot[bot]' }}
        steps:
            - name: Checkout Repo
              uses: actions/checkout@v3

            - name: Initialize Terraform
              run: |
                  cd terraform/src
                  terraform init -backend-config=backend.hcl

            - name: Terraform Plan
              run: |
                  cd terraform/src
                  terraform plan \
                  -var 'db_username=${{ secrets.DB_USERNAME }}' \
                  -var 'db_password=${{ secrets.DB_PASSWORD }}' \
                  -var 'my_ip_addresses=${{ secrets.IP_ADDRESSES }}' \
                  -out=terraform.plan

            - name: Terraform Apply
              run: |
                  cd terraform/src &&
                  terraform apply terraform.plan

            # Expose useful environment variables to the action such as env.CI_ACTION_REF_NAME_SLUG and env.CI_SHA_SHORT
            - uses: FranzDiebold/github-env-vars-action@v2

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v2   # More information on this action can be found below in the 'AWS Credentials' section
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_DEFAULT_REGION }}

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v1

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2
              with:
                  context: .
                  file: Dockerfile
                  push: true
                  build-args: |
                      VERSION=latest
                  tags: |
                      ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPO_NAME }}:${{ env.CI_ACTION_REF_NAME_SLUG }}.${{ env.CI_SHA_SHORT }}
                      ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPO_NAME }}:latest
                  labels: repository=${{ github.repository }} gh_job=${{ github.job }}
                  cache-from: type=local,src=/tmp/.buildx-cache
                  cache-to: type=local,dest=/tmp/.buildx-cache

    s3_sync:
        name: Sync Data in S3
        runs-on: ubuntu-latest
        needs: [terraform_apply]
        if: ${{ github.actor != 'dependabot[bot]' }}
        steps:
            - name: Checkout Repo
              uses: actions/checkout@v3
            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.10'
            - name: Install AWS CLI
              run: |
                  python -m pip install --upgrade pip setuptools wheel
                  pip install awscli
            - name: Sync Data in S3
              run: |
                  echo "S3_BUCKET_NAME=${S3_BUCKET_NAME}" >> $GITHUB_ENV
                  echo "s3://${{ env.S3_BUCKET_NAME }}"
                  aws s3 sync test-bucket-data 's3://${{ env.S3_BUCKET_NAME }}' --delete
